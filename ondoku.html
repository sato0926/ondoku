<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発音評価アプリ「音読しようぜ！」</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
        }
        .correct {
            color: #10b981; /* green-500 */
            font-weight: bold;
        }
        .incorrect {
            color: #ef4444; /* red-500 */
            font-weight: bold;
            text-decoration: underline;
        }
        .recording-dot {
            width: 1rem;
            height: 1rem;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="p-8">

    <div id="app" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="container bg-white p-8 rounded-2xl shadow-xl space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">発音評価アプリ「音読しようぜ！」</h1>
            
            <!-- 認証と初期化のメッセージ -->
            <div id="auth-status" class="text-center text-sm text-gray-500">
                アプリを初期化中...
            </div>

            <!-- 英文入力エリア -->
            <div>
                <label for="target-text" class="block text-sm font-medium text-gray-700 mb-1">評価したい英文を入力してください:</label>
                <textarea id="target-text" class="w-full h-32 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="例: The quick brown fox jumps over the lazy dog."></textarea>
            </div>
            
            <!-- ユーザーID表示 -->
            <div id="user-id-display" class="text-xs text-gray-500 break-all"></div>

            <!-- 英文を聞くボタン -->
            <button id="play-button" class="w-full py-3 px-6 text-white font-bold rounded-lg transition-all transform hover:scale-105 bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                英文を聞く
            </button>

            <!-- 録音ボタンとランプ -->
            <div class="flex items-center justify-center space-x-4">
                <div id="recording-indicator" class="w-4 h-4 rounded-full bg-red-400"></div>
                <button id="record-button" class="flex-1 py-3 px-6 text-white font-bold rounded-lg transition-all transform hover:scale-105 bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                    録音開始
                </button>
            </div>

            <!-- 結果表示エリア -->
            <div id="results-container" class="mt-8 space-y-4">
                <h2 class="text-2xl font-bold text-center text-gray-800">結果</h2>

                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-700 mb-2">お手本:</p>
                    <div id="target-display" class="text-gray-900 text-lg"></div>
                </div>

                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-700 mb-2">あなたの発音（認識された英文）:</p>
                    <div id="recognized-display" class="text-gray-900 text-lg"></div>
                </div>

                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <p class="text-sm font-medium text-blue-800 mb-2">採点:</p>
                    <div id="score-display" class="text-blue-600 text-3xl font-bold text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase初期化に必要なグローバル変数
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI要素
        const playButton = document.getElementById('play-button');
        const recordButton = document.getElementById('record-button');
        const targetTextarea = document.getElementById('target-text');
        const recordingIndicator = document.getElementById('recording-indicator');
        const targetDisplay = document.getElementById('target-display');
        const recognizedDisplay = document.getElementById('recognized-display');
        const scoreDisplay = document.getElementById('score-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const authStatus = document.getElementById('auth-status');

        let isRecording = false;
        let isPlaying = false;
        let recognition;
        let app;
        let db;
        let auth;
        let userId;

        // PCMをWAVに変換するヘルパー関数
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const pcmSize = pcmData.byteLength;
            const dataSize = pcmSize + 44 - 8;

            const buffer = new ArrayBuffer(44 + pcmSize);
            const view = new DataView(buffer);
            let offset = 0;

            // RIFF chunk descriptor
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, dataSize, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;
            // fmt chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4; // Subchunk1Size (16 for PCM)
            view.setUint16(offset, 1, true); offset += 2; // AudioFormat (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2; // Bits per sample
            // data chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, pcmSize, true); offset += 4;

            // PCMデータをコピー
            new Int16Array(buffer, offset).set(new Int16Array(pcmData));

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Firebaseと認証の初期化
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Firestoreのログを有効化

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ユーザーID: ${userId}`;
                        authStatus.textContent = '認証済み。準備完了。';
                        console.log("Firebase auth state changed. User ID:", userId);
                    } else {
                        userId = null;
                        authStatus.textContent = '匿名認証中...';
                        console.log("Firebase auth state changed. No user logged in.");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase認証エラー:", error);
                            authStatus.textContent = '認証に失敗しました。';
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase初期化エラー:", error);
                authStatus.textContent = 'Firebase初期化に失敗しました。';
            }
        }

        // 録音開始/停止ボタンの制御
        recordButton.addEventListener('click', async () => {
            if (isRecording) {
                // 録音停止
                recognition.stop();
            } else {
                // 録音開始
                recognizedDisplay.textContent = '話してください...';
                scoreDisplay.textContent = '';
                try {
                    recognition.start();
                } catch(e) {
                    console.error('音声認識の開始エラー:', e);
                    // マイクへのアクセスが拒否された場合
                    alert('マイクへのアクセスを許可してください。');
                }
            }
        });

        // Web Speech APIの初期化
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        } else {
            recordButton.disabled = true;
            recordButton.textContent = '音声認識非対応';
            alert('このブラウザは音声認識に対応していません。');
        }

        // recognition.onstart: 録音開始時にUIを更新
        recognition.onstart = () => {
            isRecording = true;
            recordButton.textContent = '録音停止';
            recordingIndicator.classList.add('recording-dot');
            console.log('音声認識が開始されました。');
        };

        // recognition.onend: 録音終了時にUIを更新
        recognition.onend = () => {
            isRecording = false;
            recordButton.textContent = '録音開始';
            recordingIndicator.classList.remove('recording-dot');
            console.log('音声認識が終了しました。');
            
            // onresult または onerror がすでに実行されている場合、この処理は不要
            // no-speech エラーの場合も onend が呼ばれるため、こちらで UI をリセット
            if (recognizedDisplay.textContent === '話してください...' || recognizedDisplay.textContent === '認識中...') {
                recognizedDisplay.textContent = '音声が検出されませんでした。もう一度お試しください。';
                scoreDisplay.textContent = '0%';
            }
        };

        // recognition.onresult: 音声認識結果を取得
        recognition.onresult = event => {
            const transcript = event.results[0][0].transcript;
            const score = calculateScore(targetTextarea.value, transcript);
            displayResults(targetTextarea.value, transcript, score);
            saveResultToFirestore(targetTextarea.value, transcript, score);
        };

        // recognition.onerror: 音声認識エラーを処理
        recognition.onerror = event => {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'no-speech') {
                recognizedDisplay.textContent = '音声が検出されませんでした。もう一度お試しください。';
            } else {
                recognizedDisplay.textContent = `認識エラー: ${event.error}`;
            }
            scoreDisplay.textContent = '0%';
        };

        // 英文を聞くボタンの制御
        playButton.addEventListener('click', async () => {
            if (isPlaying) return;
            isPlaying = true;

            const text = targetTextarea.value;
            if (!text) {
                alert('英文を入力してください。');
                isPlaying = false;
                return;
            }

            try {
                // Gemini TTS APIへのリクエスト
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                // 20代女性アメリカ英語話者を想定した声を選択
                                prebuiltVoiceConfig: { voiceName: "Leda" } 
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                let response;
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {
                    console.error('Fetch error:', e);
                }

                if (!response || !response.ok) {
                    console.error('TTS APIからの応答エラー:', response?.status);
                    alert('英文の読み上げに失敗しました。');
                    isPlaying = false;
                    return;
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                        isPlaying = false;
                    };
                } else {
                    console.error('TTS APIからの無効なオーディオデータ:', result);
                    alert('音声データの取得に失敗しました。');
                    isPlaying = false;
                }

            } catch (error) {
                console.error('TTS処理中のエラー:', error);
                alert('英文の読み上げに失敗しました。');
                isPlaying = false;
            }
        });

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // スコアを計算し、結果を表示
        function calculateScore(target, recognized) {
            const targetWords = target.toLowerCase().replace(/[.,!?;:]/g, '').split(/\s+/).filter(w => w);
            const recognizedWords = recognized.toLowerCase().replace(/[.,!?;:]/g, '').split(/\s+/).filter(w => w);

            let correctCount = 0;
            const displayedWords = [];

            // 単語ごとに比較
            for (let i = 0; i < recognizedWords.length; i++) {
                const recWord = recognizedWords[i];
                if (i < targetWords.length && recWord === targetWords[i]) {
                    correctCount++;
                    displayedWords.push(`<span class="correct">${recWord}</span>`);
                } else {
                    displayedWords.push(`<span class="incorrect">${recWord}</span>`);
                }
            }

            const score = Math.round((correctCount / Math.max(targetWords.length, recognizedWords.length)) * 100);
            return score;
        }

        // UIに結果を表示
        function displayResults(target, recognized, score) {
            const targetWords = target.split(/\s+/).filter(w => w);
            const recognizedWords = recognized.split(/\s+/).filter(w => w);

            // recognizedDisplayを単語ごとに色分けして表示
            let recognizedHtml = '';
            for (let i = 0; i < recognizedWords.length; i++) {
                const recWord = recognizedWords[i];
                if (i < targetWords.length && recWord.toLowerCase().replace(/[.,!?;:]/g, '') === targetWords[i].toLowerCase().replace(/[.,!?;:]/g, '')) {
                    recognizedHtml += `<span class="correct">${recWord}</span> `;
                } else {
                    recognizedHtml += `<span class="incorrect">${recWord}</span> `;
                }
            }
            
            targetDisplay.textContent = target;
            recognizedDisplay.innerHTML = recognizedHtml.trim() || '（認識できませんでした）';
            scoreDisplay.textContent = `${score}%`;
        }

        // Firestoreに結果を保存
        async function saveResultToFirestore(target, recognized, score) {
            if (!userId) {
                console.error("ユーザーIDが未定義です。Firestoreに保存できません。");
                return;
            }
            try {
                const resultsRef = collection(db, `artifacts/${appId}/users/${userId}/pronunciation_results`);
                const newResultDoc = await addDoc(resultsRef, {
                    targetText: target,
                    recognizedText: recognized,
                    score: score,
                    timestamp: serverTimestamp()
                });
                console.log("結果がFirestoreに保存されました。ドキュメントID:", newResultDoc.id);
            } catch (e) {
                console.error("Firestoreへのデータ保存エラー:", e);
            }
        }

        // アプリ起動時の初期化
        initializeFirebase();
    </script>
</body>
</html>
